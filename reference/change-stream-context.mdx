---
title: "ChangeStreamContext"
description: "Runtime context passed to handler methods"
icon: "circle-info"
---

## Overview

`ChangeStreamContext<T>` is the main runtime object passed to every handler method (`@OnChange`, `@OnInsert`, `@OnUpdate`, `@OnDelete`, `@OnReplace`). It provides access to the event metadata, documents, and runtime actions.

## Document access

### getFullDocument

Returns the full document **after** the operation, automatically converted to the requested type using Spring's `MongoConverter`.

```java
@OnChange
void handle(ChangeStreamContext<Order> ctx) {
    Optional<Order> order = ctx.getFullDocument(Order.class);
}
```

For `DELETE` operations, the full document is not available and the method returns `Optional.empty()`.

### getFullDocumentBeforeChange

Returns the document **before** the operation (requires MongoDB 6.0+ with [pre-image](https://www.mongodb.com/docs/manual/changeStreams/#change-streams-with-document-pre--and-post-images) enabled on the collection).

```java
Optional<Order> before = ctx.getFullDocumentBeforeChange(Order.class);
```

### getUpdateDescription

For `UPDATE` operations, returns the list of updated and removed fields.

```java
ctx.getUpdateDescription().ifPresent(desc -> {
    Map<String, Object> updated = desc.getUpdatedFields();
    List<String> removed = desc.getRemovedFields();
});
```

<Tip>
**Custom conversion** â€” By default, `getFullDocument(MyType.class)` uses Spring's `MongoConverter`, which respects your `@Field` annotations, custom converters registered in `MongoCustomConversions`, etc.

If you need a completely different conversion strategy (e.g. Jackson, Gson), retrieve the raw BSON document and convert it yourself:

```java
@OnChange
void handle(ChangeStreamContext<?> ctx) {
    Document raw = ctx.getFullDocument(Document.class).orElse(null);
    if (raw != null) {
        MyType obj = myCustomMapper.fromBson(raw.toJson());
    }
}
```
</Tip>

## Event metadata

| Method | Returns | Description |
|--------|---------|-------------|
| `getEventId()` | `String` | Unique ID generated by FlowWarden for this event |
| `getOperationType()` | `OperationType` | `INSERT`, `UPDATE`, `REPLACE`, `DELETE`, `DROP`, `INVALIDATE` |
| `getStreamName()` | `String` | Name of the `@ChangeStream` handler |
| `getCollectionName()` | `String` | Source MongoDB collection |
| `getDatabaseName()` | `String` | Source MongoDB database |
| `getClusterTime()` | `Instant` | MongoDB cluster timestamp |
| `getResumeToken()` | `BsonDocument` | Resume token for checkpointing |
| `getDocumentKey()` | `BsonValue` | The `_id` of the affected document |
| `getAttemptNumber()` | `int` | Current retry attempt (1-based) |

## Actions

### sendToDlq

Manually routes the current event to the Dead Letter Queue.

```java
ctx.sendToDlq("Invalid order total");
```

### saveCheckpointNow

Forces an immediate checkpoint save for the current resume token.

```java
ctx.saveCheckpointNow();
```

## Custom metadata

Attach arbitrary key-value pairs to the event for downstream processing.

```java
ctx.addMetadata("processingRegion", "eu-west-1");

Optional<String> region = ctx.getMetadata("processingRegion", String.class);
Map<String, Object> all = ctx.getAllMetadata(); // unmodifiable
```
